<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
  <meta charset="UTF-8">
  <title th:text="${campaign.campaignId == null} ? 'Создать кампанию' : 'Редактировать кампанию'">Кампания</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<!-- Навигационное меню -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <a class="navbar-brand" th:href="@{/dashboard}">MarketingAgencyApp</a>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" th:href="@{/dashboard}">Главная</a></li>
      <li class="nav-item"><a class="nav-link" th:href="@{/campaigns}">Кампании</a></li>
      <li class="nav-item"><a class="nav-link" th:href="@{/channels}">Каналы</a></li>
      <li class="nav-item"><a class="nav-link" th:href="@{/audiences}">Аудитории</a></li>
      <li class="nav-item"><a class="nav-link" th:href="@{/reports}">Отчёты</a></li>
      <li class="nav-item"><a class="nav-link" th:href="@{/about}">Об авторе</a></li>
    </ul>
    <!-- Кнопка Logout -->
    <form th:action="@{/logout}" method="post" class="form-inline my-2 my-lg-0 ml-auto">
      <button class="btn btn-outline-danger my-2 my-sm-0" type="submit">Logout</button>
    </form>
  </div>
</nav>

<!-- Основной контент -->
<div class="container mt-4">
  <h1 th:text="${campaign.campaignId == null} ? 'Создать кампанию' : 'Редактировать кампанию'">Кампания</h1>
  <form th:action="@{/campaign/save}" method="post" th:object="${campaign}">
    <!-- Скрытое поле для идентификатора кампании -->
    <input type="hidden" th:field="*{campaignId}">

    <!-- Общая информация -->
    <div class="form-group">
      <label for="name">Название кампании</label>
      <input type="text" id="name" th:field="*{name}" class="form-control" placeholder="Введите название" required>
    </div>
    <div class="form-group">
      <label for="description">Описание</label>
      <textarea id="description" th:field="*{description}" class="form-control" rows="3" placeholder="Введите описание"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group col-md-6">
        <label for="startDate">Дата начала</label>
        <!-- th:field автоподставит значение, если campaign.startDate не null -->
        <input type="date" id="startDate" th:field="*{startDate}" class="form-control" required>
      </div>
      <div class="form-group col-md-6">
        <label for="endDate">Дата окончания</label>
        <input type="date" id="endDate" th:field="*{endDate}" class="form-control" required>
      </div>
    </div>
    <div class="form-group">
      <label for="totalBudget">Общий бюджет</label>
      <input type="number" id="totalBudget" th:field="*{totalBudget}" class="form-control" step="0.01" placeholder="Введите бюджет" required>
    </div>
    <div class="form-group">
      <label for="status">Статус кампании</label>
      <select id="status" th:field="*{status}" class="form-control">
        <option value="planned" th:selected="${campaign.status == 'planned'}">Планируется</option>
        <option value="active" th:selected="${campaign.status == 'active'}">Активна</option>
        <option value="completed" th:selected="${campaign.status == 'completed'}">Завершена</option>
      </select>
    </div>

    <!-- Блок для уже добавленных каналов -->
    <h3>Каналы продвижения (уже добавленные)</h3>
    <div id="existing-channels">
      <div th:each="cc, iterStat : ${campaign.campaignChannels}" class="existing-channel-block">
        <!-- Здесь выводим информацию о канале, который уже добавлен -->
        <div class="card mb-3">
          <div class="card-body">
            <h5 th:text="${cc.channel.name}">Название канала</h5>
            <div class="form-group">
              <label>Распределённый бюджет</label>
              <!-- Показываем бюджет в режиме readonly -->
              <input type="number" class="form-control" th:value="${cc.allocatedBudget}" readonly>
            </div>
            <!-- Скрытый input для уже существующего id, если понадобится (не обязательно, если сервер определяет по связям) -->
            <input type="hidden" name="existingChannelIds" th:value="${cc.channel.channelId}" />
            <!-- Кнопка "Удалить" -->
            <button type="button" class="btn btn-danger btn-sm"
                    th:onclick="'removeExistingChannel(this, ' + ${cc.channel.channelId} + ');'">
              Удалить канал
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Скрытое поле для накопления идентификаторов каналов, которые пользователь удалил -->
    <input type="hidden" id="deletedChannelIds" name="deletedChannelIds" />

    <!-- Блок для добавления новых каналов -->
    <h3>Добавить новый канал</h3>
    <div id="new-channels">
      <!-- Здесь будут появляться новые блоки -->
    </div>
    <button type="button" class="btn btn-secondary mb-3" onclick="addNewChannel()">Добавить канал</button>

    <!-- Шаблон для нового блока канала (скрытый) -->
    <div id="new-channel-template" style="display:none;">
      <div class="new-channel-block card mb-3">
        <div class="card-body">
          <div class="form-group">
            <label>Канал</label>
            <!-- Этот селект заполняется значениями из availableChannels -->
            <select name="newChannelIds" class="form-control">
              <option value="">Выберите канал</option>
              <option th:each="channel : ${availableChannels}"
                      th:value="${channel.channelId}"
                      th:text="${channel.name}"></option>
            </select>
          </div>
          <div class="form-group">
            <label>Распределённый бюджет</label>
            <input type="number" name="newChannelBudgets" class="form-control" step="0.01" placeholder="Введите сумму">
          </div>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeNewChannel(this)">Удалить этот блок</button>
        </div>
      </div>
    </div>

    <!-- Блок для сегментов аудитории -->
    <h3>Сегменты аудитории</h3>
    <!-- Используем th:field для биндинга массива/коллекции. Предполагается, что в объекте Campaign есть свойство audienceIds типа List<Long>,
         которое при редактировании содержит идентификаторы выбранных сегментов аудитории -->
    <div class="form-group">
      <label>Выберите аудитории</label>
      <select th:field="*{audienceIds}" class="form-control" multiple>
        <option th:each="audience : ${audiences}"
                th:value="${audience.audienceId}"
                th:text="${audience.name}"></option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">Сохранить кампанию</button>
    <a th:href="@{/campaigns}" class="btn btn-secondary">Отмена</a>
  </form>
</div>

<!-- Скрипты -->
<script>
  // Функция для удаления уже добавленного канала.
  function removeExistingChannel(btn, channelId) {
    // Получаем текущие id удалённых каналов из скрытого поля.
    var deletedField = document.getElementById("deletedChannelIds");
    var currentIds = deletedField.value ? deletedField.value.split(",") : [];
    // Добавляем новый id, если его там ещё нет.
    if (currentIds.indexOf(channelId.toString()) === -1) {
      currentIds.push(channelId);
    }
    deletedField.value = currentIds.join(",");
    // Удаляем блок канала из DOM.
    $(btn).closest('.existing-channel-block').remove();
  }

  // Функция для добавления нового блока канала.
  function addNewChannel() {
    // Получаем HTML шаблона (скрытого блока)
    var template = document.getElementById("new-channel-template").innerHTML;
    // Добавляем скопированный блок в контейнер "new-channels"
    document.getElementById("new-channels").insertAdjacentHTML('beforeend', template);
  }

  // Функция для удаления нового блока канала.
  function removeNewChannel(btn) {
    $(btn).closest('.new-channel-block').remove();
  }
</script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
